# Kube Proxy
- Take me to [Video Tutorial](https://kodekloud.com/topic/kube-proxy/)

In this section, we will take a look at kube-proxy.

Within Kubernetes Cluster, every pod can reach every other pod. This is accomplished by deploying a pod networking cluster to the cluster. 
- Kube-Proxy is a process that runs on each node in the kubernetes cluster.
  
  ![kube-proxy](../../images/kube-proxy.PNG)

# kube-proxyè¯¦è§£

`kube-proxy` **æ˜¯ Kubernetesï¼ˆK8sï¼‰é›†ç¾¤ä¸­ä¸€ä¸ª****å…³é”®çš„ç½‘ç»œç»„ä»¶****ï¼Œè¿è¡Œåœ¨****æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼ˆNodeï¼‰****ä¸Šï¼Œä¸»è¦ä½œç”¨æ˜¯****å®ç°é›†ç¾¤å†…éƒ¨ Service çš„ç½‘ç»œä»£ç†å’Œè´Ÿè½½å‡è¡¡****ï¼Œç¡®ä¿ Pod ä¹‹é—´ã€ä»¥åŠå¤–éƒ¨åˆ° Service çš„æµé‡èƒ½å¤Ÿæ­£ç¡®è·¯ç”±ã€‚**

---

## æ ¸å¿ƒä½œç”¨ä¸€å¥è¯æ€»ç»“ï¼š

> **`kube-proxy` **è´Ÿè´£å°†å‘å¾€ Kubernetes Service çš„æµé‡ï¼Œè½¬å‘åˆ°åç«¯çœŸå®çš„ Pod å®ä¾‹ä¸Šã€‚****

---

## è¯¦ç»†åŠŸèƒ½è§£æ

### 1. **å®ç° Service çš„è™šæ‹Ÿ IPï¼ˆClusterIPï¼‰æœºåˆ¶**

* **åœ¨ K8s ä¸­ï¼ŒService ä¼šåˆ†é…ä¸€ä¸ªè™šæ‹Ÿ IPï¼ˆå¦‚** `10.96.0.1`ï¼‰ï¼Œè¿™ä¸ª IP  **ä¸æ˜¯çœŸå®ç½‘å¡ä¸Šçš„åœ°å€** **ã€‚**
* `kube-proxy` **é€šè¿‡æ“ä½œèŠ‚ç‚¹çš„ç½‘ç»œè§„åˆ™ï¼ˆiptables æˆ– IPVSï¼‰ï¼Œ** **æ‹¦æˆªå‘å¾€è¯¥è™šæ‹Ÿ IP çš„æµé‡** **ï¼Œå¹¶å°†å…¶** **é‡å®šå‘åˆ°åç«¯æŸä¸ªå¥åº·çš„ Pod** **ã€‚**

### 2. **è´Ÿè½½å‡è¡¡ï¼ˆLoad Balancingï¼‰**

* **å½“ Service åç«¯æœ‰å¤šä¸ª Pod æ—¶ï¼Œ**`kube-proxy` **ä¼šåœ¨è¿™äº› Pod ä¹‹é—´** **åšè´Ÿè½½åˆ†å‘** **ï¼ˆé»˜è®¤æ˜¯éšæœºæˆ–è½®è¯¢ï¼‰ã€‚**
* **ä¾‹å¦‚ï¼šè®¿é—®** `my-service:80`ï¼Œå®é™…å¯èƒ½è¢«è½¬å‘åˆ° `podA:8080`ã€`podB:8080` **æˆ–** `podC:8080`ã€‚

### 3. **ç»´æŠ¤ç½‘ç»œè§„åˆ™ï¼ˆæ ¹æ® Endpoint å˜åŒ–åŠ¨æ€æ›´æ–°ï¼‰**

* `kube-proxy` **ä¼šç›‘å¬ API Server ä¸­**  **Service å’Œ Endpointï¼ˆæˆ– EndpointSliceï¼‰å¯¹è±¡çš„å˜åŒ–** **ã€‚**
* **å½“ Pod å¢åˆ ã€å´©æºƒã€æ‰©ç¼©å®¹æ—¶ï¼ŒEndpoint åˆ—è¡¨ä¼šæ›´æ–° â†’** `kube-proxy` **è‡ªåŠ¨è°ƒæ•´è½¬å‘è§„åˆ™ï¼Œ** **ç¡®ä¿æµé‡åªå‘ç»™å¥åº· Pod** **ã€‚**

### 4. **æ”¯æŒå¤šç§ Service ç±»å‹**

**æ— è®ºä½ ä½¿ç”¨å“ªç§ Service ç±»å‹ï¼Œ**`kube-proxy` **éƒ½å‚ä¸æµé‡å¤„ç†ï¼š**

* `ClusterIP`ï¼ˆé›†ç¾¤å†…éƒ¨è®¿é—®ï¼‰
* `NodePort`ï¼ˆé€šè¿‡èŠ‚ç‚¹ IP + ç«¯å£æš´éœ²ï¼‰
* `LoadBalancer`ï¼ˆäº‘å‚å•† LB åç«¯ä»ä¾èµ– kube-proxy è½¬å‘åˆ° Podï¼‰

> **ğŸ’¡ æ³¨æ„ï¼š**`ExternalName` **ç±»å‹çš„ Service ä¸ç»è¿‡** `kube-proxy`ï¼Œå®ƒåªæ˜¯ DNS CNAMEã€‚

---

## å·¥ä½œæ¨¡å¼ï¼ˆBackend Modesï¼‰

`kube-proxy` **æ”¯æŒä¸‰ç§å®ç°æ–¹å¼ï¼ˆé€šè¿‡** `--proxy-mode` **å‚æ•°é…ç½®ï¼‰ï¼š**

--proxy-mode=iptables

| **æ¨¡å¼**                               | **åŸç†**                                        | **ä¼˜ç‚¹**                                                            | **ç¼ºç‚¹**                                    |
| -------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------------------- | ------------------------------------------------- |
| **`iptables`** **ï¼ˆé»˜è®¤ï¼‰**    |                                                       | **ç¨³å®šã€å…¼å®¹æ€§å¥½ã€æ— éœ€é¢å¤–ä¾èµ–**                                    | **è§„åˆ™å¤æ‚æ—¶æ€§èƒ½ä¸‹é™ï¼ˆO(n) åŒ¹é…ï¼‰**         |
| **`ipvs`**                           | **åŸºäº Linux IP Virtual Serverï¼ˆLVSï¼‰å†…æ ¸æ¨¡å—** | **é«˜æ€§èƒ½ï¼ˆO(1) æŸ¥æ‰¾ï¼‰ã€æ”¯æŒæ›´å¤šè´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆrr, lc, wrr, sh ç­‰ï¼‰** | **éœ€è¦å†…æ ¸æ”¯æŒï¼ˆâ‰¥4.19 æ¨èï¼‰ï¼Œé…ç½®ç¨å¤æ‚** |
| **`userspace`** **ï¼ˆå·²åºŸå¼ƒï¼‰** | **åœ¨ç”¨æˆ·ç©ºé—´ç”¨ Go ç¨‹åºä»£ç†æµé‡**                | **æ—©æœŸæ–¹æ¡ˆ**                                                        | **æ€§èƒ½å·®ã€å»¶è¿Ÿé«˜ï¼Œ****K8s 1.23+ å·²ç§»é™¤**    |

> **âœ…**  **ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ `ipvs` **æ¨¡å¼**** **ï¼ˆå°¤å…¶åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­ï¼‰ã€‚**

## ä¸¾ä¸ªä¾‹å­

**å‡è®¾ä½ æœ‰ä¸€ä¸ª Serviceï¼š**

```
apiVersion: v1
kind: Service
metadata:
 name: web
  spec:
   selector:
    app: nginx
   ports:
    -port:80
     targetPort:8080
```

**åç«¯æœ‰ä¸¤ä¸ª Podï¼š**

* `nginx-pod-1`ï¼ˆIP: 10.244.1.10ï¼‰
* `nginx-pod-2`ï¼ˆIP: 10.244.2.20ï¼‰

**å½“ä½ åœ¨é›†ç¾¤å†…æ‰§è¡Œï¼š**

```
curl http://web
```

**`kube-proxy` **åœ¨èŠ‚ç‚¹ä¸Šåšäº†ä»€ä¹ˆï¼Ÿ****

1. **æ‹¦æˆªå‘å¾€** `web` **Service ClusterIPï¼ˆå¦‚** `10.96.1.100:80`ï¼‰çš„è¯·æ±‚ï¼›
2. **ä» Endpoints ä¸­è·å–åç«¯ Pod åˆ—è¡¨** `[10.244.1.10:8080, 10.244.2.20:8080]`ï¼›
3. **éšæœºé€‰æ‹©ä¸€ä¸ªï¼ˆæ¯”å¦‚** `10.244.1.10:8080`ï¼‰ï¼›
4. **é€šè¿‡ iptables/IPVS å°†æµé‡ DNAT è½¬å‘è¿‡å»ã€‚**

---

## å¸¸è§è¯¯è§£æ¾„æ¸…

| **è¯¯è§£**                                      | **æ­£ç¡®ç†è§£**                                                                                         |
| --------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| **â€œkube-proxy æ˜¯ä¸€ä¸ªåå‘ä»£ç†ï¼ˆåƒ Nginxï¼‰â€** | **âŒ å®ƒä¸ç›´æ¥å¤„ç† HTTPï¼Œè€Œæ˜¯æ“ä½œåº•å±‚ç½‘ç»œï¼ˆL4 å±‚ï¼šTCP/UDPï¼‰**                                         |
| **â€œæ¯ä¸ª Service éƒ½æœ‰ä¸€ä¸ª kube-proxy è¿›ç¨‹â€** | **âŒ æ¯ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ä¸ª** `kube-proxy` **è¿›ç¨‹ï¼Œç®¡ç†æœ¬èŠ‚ç‚¹æ‰€æœ‰ Service æµé‡**                   |
| **â€œCNI æ’ä»¶æ›¿ä»£äº† kube-proxyâ€**             | **âŒ CNI è´Ÿè´£ Pod ç½‘ç»œï¼ˆPod â†” Podï¼‰ï¼Œ**`kube-proxy` **è´Ÿè´£ Service ç½‘ç»œï¼ˆService â†” Podï¼‰** |

> **ğŸ”” æ³¨æ„ï¼šæŸäº›é«˜çº§ CNIï¼ˆå¦‚ Ciliumã€Calico with eBPFï¼‰å¯ä»¥** **ç»•è¿‡ kube-proxy** **ï¼Œç”¨ eBPF ç›´æ¥å®ç° Service è½¬å‘ï¼Œä½†è¿™å±äºä¼˜åŒ–æ–¹æ¡ˆï¼Œä¸æ˜¯é»˜è®¤è¡Œä¸ºã€‚**

---

## æ€»ç»“ï¼š`kube-proxy` **çš„å…³é”®ä»·å€¼**

| **åŠŸèƒ½**             | **è¯´æ˜**                                       |
| -------------------------- | ---------------------------------------------------- |
| **Service æŠ½è±¡å®ç°** | **è®©ç”¨æˆ·æ— éœ€å…³å¿ƒ Pod IP å˜åŒ–**                 |
| **é€æ˜è´Ÿè½½å‡è¡¡**     | **è‡ªåŠ¨åˆ†å‘æµé‡åˆ°å¥åº· Pod**                     |
| **åŠ¨æ€ç½‘ç»œæ›´æ–°**     | **éš Pod ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨è°ƒæ•´è§„åˆ™**                |
| **è·¨èŠ‚ç‚¹é€šä¿¡æ”¯æŒ**   | **å³ä½¿ Pod åœ¨ä¸åŒèŠ‚ç‚¹ï¼Œä¹Ÿèƒ½é€šè¿‡ Service è®¿é—®** |

> **ğŸŒŸ å¯ä»¥è¯´ï¼š****æ²¡æœ‰ `kube-proxy`ï¼ˆæˆ–å…¶æ›¿ä»£æ–¹æ¡ˆï¼‰ï¼ŒKubernetes çš„ Service æœºåˆ¶å°±æ— æ³•å·¥ä½œã€‚**

**å¦‚æœä½ æ­£åœ¨æ’æŸ¥â€œService æ— æ³•è®¿é—®â€é—®é¢˜ï¼Œæ£€æŸ¥** `kube-proxy` **æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ˆPod çŠ¶æ€ã€æ—¥å¿—ã€æ¨¡å¼é…ç½®ï¼‰å¾€å¾€æ˜¯ç¬¬ä¸€æ­¥ã€‚éœ€è¦æˆ‘æä¾›æ’æŸ¥å‘½ä»¤å—ï¼Ÿ**



# æµé‡ DNAT æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

**â€œæµé‡ DNATâ€ æ˜¯æŒ‡åœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œ****å¯¹æ•°æ®åŒ…çš„ç›®æ ‡åœ°å€ï¼ˆDestination IP/Portï¼‰è¿›è¡ŒåŠ¨æ€ä¿®æ”¹**çš„ä¸€ç§ç½‘ç»œåœ°å€è½¬æ¢ï¼ˆNATï¼‰æŠ€æœ¯ã€‚DNAT å…¨ç§°æ˜¯  **Destination Network Address Translation** **ï¼ˆç›®çš„åœ°å€è½¬æ¢ï¼‰ã€‚**

---

## ä¸€å¥è¯å®šä¹‰ï¼š

> **DNAT å°±æ˜¯æŠŠå‘å¾€æŸä¸ªå…¬ç½‘ IP å’Œç«¯å£çš„æµé‡ï¼Œâ€œé‡å®šå‘â€åˆ°å†…ç½‘ä¸­æŸå°æœåŠ¡å™¨çš„çœŸå®ç§æœ‰ IP å’Œç«¯å£ä¸Šã€‚**

---

## æ ¸å¿ƒä½œç”¨

**DNAT ä¸»è¦ç”¨äº** **â€œå¤–ç½‘è®¿é—®å†…ç½‘æœåŠ¡â€** **çš„åœºæ™¯ï¼Œè§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š**

1. **å†…ç½‘æœåŠ¡å™¨æ²¡æœ‰å…¬ç½‘ IP** **ï¼ˆä½¿ç”¨çš„æ˜¯** `192.168.x.x`ã€`10.x.x.x` **ç­‰ç§æœ‰åœ°å€ï¼‰ï¼›**
2. **å¤–éƒ¨ç”¨æˆ·åªçŸ¥é“å…¬ç½‘å…¥å£åœ°å€ï¼Œä¸çŸ¥é“å†…ç½‘ç»“æ„** **ã€‚**

**é€šè¿‡ DNATï¼Œé˜²ç«å¢™æˆ–è·¯ç”±å™¨å¯ä»¥å……å½“â€œç¿»è¯‘å®˜â€ï¼ŒæŠŠå¤–éƒ¨è¯·æ±‚****é€æ˜åœ°è½¬å‘**ç»™å†…éƒ¨æœåŠ¡ã€‚

---

## å…¸å‹åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šå‘å¸ƒå†…ç½‘ Web æœåŠ¡å™¨

* **ä½ æœ‰ä¸€å°å†…ç½‘æœåŠ¡å™¨ï¼š**`192.168.1.100:8080`
* **å…¬ç½‘ IP æ˜¯ï¼š**`203.0.113.10`
* **é…ç½® DNAT è§„åˆ™ï¼š**
  

  ```
  å½“å¤–éƒ¨è®¿é—® 203.0.113.10:80 æ—¶ï¼Œ
  è‡ªåŠ¨å°†ç›®æ ‡åœ°å€æ”¹ä¸º 192.168.1.100:8080
  ```
* **ç”¨æˆ·è®¿é—®** `http://203.0.113.10` **å°±èƒ½æ‰“å¼€ä½ çš„ç½‘ç«™ï¼Œ** **å®Œå…¨ä¸çŸ¥é“åç«¯æ˜¯å†…ç½‘æœºå™¨** **ã€‚**

### åœºæ™¯ 2ï¼šè¿œç¨‹ SSH è®¿é—®å†…ç½‘ä¸»æœº

**è¿œç¨‹ SSH** **æ˜¯æŒ‡é€šè¿‡**  **SSHï¼ˆSecure Shellï¼‰åè®®** **ï¼Œä»ä¸€å°è®¡ç®—æœºå®‰å…¨åœ°ç™»å½•å¹¶æ“ä½œå¦ä¸€å°ä½äºè¿œç¨‹ç½‘ç»œï¼ˆå¦‚å…¬å¸æœåŠ¡å™¨ã€äº‘ä¸»æœºã€å®¶é‡Œçš„æ ‘è“æ´¾ç­‰ï¼‰çš„è®¡ç®—æœºã€‚**

* **å†…ç½‘ä¸»æœºï¼š**`10.0.0.5:22`
* **å…¬ç½‘é˜²ç«å¢™ IPï¼š**`203.0.113.10`
* **é…ç½® DNATï¼š**
  

  ```
  å¤–éƒ¨è®¿é—® 203.0.113.10:2222 â†’ è½¬å‘åˆ° 10.0.0.5:22
  ```
* **ä½ å°±å¯ä»¥ç”¨** `ssh -p 2222 user@203.0.113.10` **ç™»å½•å†…ç½‘æœºå™¨ã€‚**



### åœºæ™¯ 3ï¼šäº‘å¹³å°è´Ÿè½½å‡è¡¡ï¼ˆå¦‚ Azureã€AWSï¼‰

* **äº‘å‚å•†çš„â€œå…¬ç½‘è´Ÿè½½å‡è¡¡å™¨â€èƒŒåå°±æ˜¯ DNATï¼š**
  * **å…¬ç½‘ VIPï¼ˆè™šæ‹Ÿ IPï¼‰æ¥æ”¶è¯·æ±‚ï¼›**
  * **é€šè¿‡ DNAT è§„åˆ™ï¼Œå°†æµé‡åˆ†å‘åˆ°åç«¯å¤šä¸ªç§æœ‰ IP çš„è™šæ‹Ÿæœºæˆ–å®¹å™¨ã€‚**

---

## æŠ€æœ¯å®ç°æ–¹å¼ï¼ˆä»¥ Linux ä¸ºä¾‹ï¼‰

**åœ¨ Linux ä¸­ï¼ŒDNAT é€šå¸¸é€šè¿‡** **`iptables`** **æˆ–** **`nftables`** **å®ç°ï¼š**

```
# ç¤ºä¾‹ï¼šå°†è®¿é—®å…¬ç½‘ 203.0.113.10:80 çš„æµé‡è½¬åˆ°å†…ç½‘ 192.168.1.100:8080
iptables -t nat -A PREROUTING \
  -d 203.0.113.10 -p tcp --dport 80\
  -j DNAT --to-destination 192.168.1.100:8080
```

 **æ³¨æ„ï¼šé€šå¸¸è¿˜éœ€è¦é…åˆ** **SNATï¼ˆæºåœ°å€è½¬æ¢ï¼‰** **æˆ–å¯ç”¨**  **IP è½¬å‘** **ï¼ˆ**`net.ipv4.ip_forward=1`ï¼‰ï¼Œå¦åˆ™å›ç¨‹æµé‡å¯èƒ½æ— æ³•æ­£ç¡®è¿”å›ã€‚

---

## DNAT vs SNAT å¯¹æ¯”

| **ç‰¹æ€§**     | **DNATï¼ˆç›®çš„åœ°å€è½¬æ¢ï¼‰**             | **SNATï¼ˆæºåœ°å€è½¬æ¢ï¼‰**                |
| ------------------ | ------------------------------------------ | ------------------------------------------- |
| **ä¿®æ”¹å­—æ®µ** | **ç›®æ ‡ IP / ç«¯å£**                   | **æº IP / ç«¯å£**                      |
| **å…¸å‹ç”¨é€”** | **å¤–ç½‘ â†’ å†…ç½‘ï¼ˆå‘å¸ƒæœåŠ¡ï¼‰**         | **å†…ç½‘ â†’ å¤–ç½‘ï¼ˆä¸Šç½‘ï¼‰**              |
| **è§¦å‘æ—¶æœº** | **æ•°æ®åŒ…è¿›å…¥é˜²ç«å¢™æ—¶ï¼ˆPREROUTINGï¼‰** | **æ•°æ®åŒ…ç¦»å¼€é˜²ç«å¢™æ—¶ï¼ˆPOSTROUTINGï¼‰** |
| **ç”¨æˆ·æ„ŸçŸ¥** | **å¤–éƒ¨ç”¨æˆ·æ— æ„Ÿ**                     | **å†…ç½‘ç”¨æˆ·æ— æ„Ÿ**                      |

> **å¯ä»¥ç†è§£ä¸ºï¼š**
>
> * **DNAT æ˜¯â€œè¯·è¿›æ¥â€** **ï¼ˆå¯¹å¤–å¼€æ”¾æœåŠ¡ï¼‰**
> * **SNAT æ˜¯â€œèµ°å‡ºå»â€** **ï¼ˆå†…ç½‘ä¸Šç½‘ï¼‰**

---

## å®‰å…¨ä¸æ¶æ„ä»·å€¼

* **éšè—å†…ç½‘æ‹“æ‰‘** **ï¼šå¤–éƒ¨åªèƒ½çœ‹åˆ°å…¬ç½‘ IPï¼Œä¸çŸ¥é“å†…éƒ¨æœ‰å¤šå°‘å°æœåŠ¡å™¨ã€‚**
* **é›†ä¸­è®¿é—®æ§åˆ¶** **ï¼šæ‰€æœ‰å…¥ç«™æµé‡ç»è¿‡é˜²ç«å¢™ï¼Œå¯ç»Ÿä¸€åš ACLã€å®¡è®¡ã€é˜²æ”»å‡»ã€‚**
* **çµæ´»æ˜ å°„** **ï¼šä¸€ä¸ªå…¬ç½‘ IP å¯ä»¥é€šè¿‡ä¸åŒç«¯å£æ˜ å°„åˆ°å¤šä¸ªå†…ç½‘æœåŠ¡ï¼ˆç«¯å£å¤ç”¨ï¼‰ã€‚**

---

## æ€»ç»“

> **â€œæµé‡ DNATâ€ = æŠŠå¤–éƒ¨æµé‡çš„ç›®æ ‡åœ°å€æ”¹å†™æˆå†…ç½‘æœåŠ¡å™¨åœ°å€ï¼Œå®ç°å®‰å…¨ã€é€æ˜çš„æœåŠ¡æš´éœ²ã€‚**

**å®ƒæ˜¯ä¼ä¸šç½‘ç»œã€äº‘å¹³å°ã€å®¶åº­è·¯ç”±å™¨ï¼ˆå¦‚ç«¯å£è½¬å‘ï¼‰ä¸­** **æœ€åŸºç¡€ä¹Ÿæœ€å…³é”®çš„ç½‘ç»œæŠ€æœ¯ä¹‹ä¸€** **ã€‚**

  
## Install kube-proxy - Manual
- Download the kube-proxy binary from the kubernetes release pages [kube-proxy](https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-proxy). For example: To download kube-proxy v1.13.0, Run the below command.
  ```
  $ wget https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-proxy
  ```
- Extract it
- Run it as a service

  ![kube-proxy1](../../images/kube-proxy1.PNG)

## View kube-proxy options - kubeadm
- If you set it up with kubeadm tool, kubeadm tool will deploy the kube-proxy as pod in kube-system namespace. In fact it is deployed as a daemonset on master node.
  ```
  $ kubectl get pods -n kube-system
  ```
  ![kube-proxy2](../../images/kube-proxy2.PNG)
  
  
K8s Reference Docs:
- https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/
- https://kubernetes.io/docs/concepts/overview/components/
